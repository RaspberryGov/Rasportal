<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Market</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tronweb@4.5.1/dist/tronweb.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f0f0f0;
      }
      .price-widget {
        padding: 20px;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .error {
        color: red;
        margin-top: 10px;
      }
      .loading {
        margin-top: 10px;
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const TronWeb = window.TronWeb;
      let tronWeb;

      const SunSwapPriceWidget = () => {
          const [price, setPrice] = React.useState(null);
          const [loading, setLoading] = React.useState(true);
          const [error, setError] = React.useState(null);
          const pairContractAddress = 'TM6fUHjWvB4kL91GiNTZrkDu5uzKEgGXoz';

          const pairContractABI = [
              {
                  "constant": true,
                  "inputs": [],
                  "name": "getReserves",
                  "outputs": [
                      { "internalType": "uint256", "name": "reserve0", "type": "uint256" },
                      { "internalType": "uint256", "name": "reserve1", "type": "uint256" },
                      { "internalType": "uint256", "name": "blockTimestampLast", "type": "uint256" }
                  ],
                  "payable": false,
                  "stateMutability": "view",
                  "type": "function"
              },
          ];

          React.useEffect(() => {
              const initializeTronWeb = async () => {
                  try {
                      if (window && (window as any).tronWeb) {
                          tronWeb = (window as any).tronWeb;
                      } else {
                        const HttpProvider = TronWeb.providers.HttpProvider;
                        const fullNode = new HttpProvider({ fullNode: 'https://api.trongrid.io' });
                        const solidityNode = new HttpProvider({ solidityNode: 'https://api.trongrid.io' });
                        const eventServer = new HttpProvider({ eventServer: 'https://api.trongrid.io' });
                        tronWeb = new TronWeb(fullNode, solidityNode, eventServer);
                      }

                      if (!tronWeb.defaultAddress) {
                          setError("TronWeb is not initialized.  Please ensure TronLink is installed and connected, or provide a default address.");
                          setLoading(false);
                          return;
                      }
                  } catch (e: any) {
                      setError(`Error initializing TronWeb: ${e.message}`);
                      setLoading(false);
                      return;
                  }
              };

              const fetchTokenPrice = async () => {
                  if (!tronWeb) {
                      return;
                  }
                  setLoading(true);
                  setError(null);
                  try {
                      const pairContract = await tronWeb.contract(pairContractABI, pairContractAddress);
                      const reserves = await pairContract.getReserves().call();
                      const reserve0 = reserves.reserve0.toNumber();
                      const reserve1 = reserves.reserve1.toNumber();

                      const decimals0 = 18;
                      const decimals1 = 18;


                      const calculatedPrice = (reserve1 * Math.pow(10, decimals0)) / (reserve0 * Math.pow(10, decimals1));
                      setPrice(calculatedPrice);
                  } catch (e: any) {
                      setError(`Error fetching price: ${e.message}`);
                  } finally {
                      setLoading(false);
                  }
              };

              initializeTronWeb().then(() => {
                  fetchTokenPrice();
                  const intervalId = setInterval(fetchTokenPrice, 10000);

                  return () => clearInterval(intervalId);
              });
          }, []);

          return (
              <div className="price-widget">
                  <h2 className="text-lg font-semibold mb-4 text-gray-800">SunSwap Price</h2>
                  {loading ? (
                      <div className="loading">Loading price...</div>
                  ) : error ? (
                      <div className="error">{error}</div>
                  ) : price !== null ? (
                      <div className="text-2xl font-bold text-gray-900">
                          {price.toFixed(6)}
                      </div>
                  ) : (
                      <div className="text-gray-500">
                          Price not available.
                      </div>
                  )}
                  <div className="mt-4">
                      <p className="text-sm text-gray-600">
                          Trading Pair: {pairContractAddress}
                      </p>
                  </div>
              </div>
          );
      };

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
